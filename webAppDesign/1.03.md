# Web应用开发实录后端篇 后端程序编写 设计接口处理流程

上文中，我们小试牛刀，尝试了各种方法，终于搞定了数据库的模型文件，并且顺利的生成了一个数据库。但那仅仅是数据库而已。

我们还得好好想想，我们的后端构架，到底要如何来实现。我们先来分析一下我们的需求：

1. 我们的程序需要启动一个 `http` 服务。
2. 我们的服务需要对应多个 `api` 前缀。
3. `/api/v1/be/` 前缀的接口需要登录。
4. `/api/v1/fe/` 前缀的接口只有 `GET` 权限。
5. 将数据库中存在的表，按照 `RESTful` 风格进行输出。
6. 但是这些接口并不能完全直接输出，有些需要处理一下，比如管理员密码不能给出去。
7. 除了数据库中的表，还需要补充几个其他的接口，比如登录登出。
8. ……

哎呀，这怎么实现呢？光写一个数据库模型文件，很显然是达不到我们想要的这些功能的。我们自己来设计个接口处理的流程。

后端同学开会，经过不断的头脑风暴，最终接口请求处理流程图如下：

![后端处理流程图](https://raw.githubusercontent.com/fengcms/articles/master/image/37/3fb691f8e9f63e3b0b6bee0a369fbf.svg?sanitize=true)

## 详解流程图

流程图是画出来了，但是这只是一个大纲而已，我们需要对每一步进行解释。

### 判断接口前缀

我们可以在 `/config.py` 中用一个参数，将系统要支持的接口前缀列在这里。然后我们在请求进来之后，直接读取这个参数，进行比对判断，即可判断请求的接口前缀是否是我们系统支持的。

其实这里不仅仅是需要判断了接口的前缀，还需要判断请求的 `url` 是否符合我们的设计规范。

我们的系统默认只支持以下两种 `url`

```
# list
http://__DOMAIN__/__PERFIX__/__API_NAME__

# details
http://__DOMAIN__/__PERFIX__/__API_NAME__/__:ID__
```

如果是不符合这个标准的，统统返回 `404`。

### 判断请求方法是否被允许

作为列表型的请求路径，只能被允许请求 `GET` 方法和 `POST` 方法，而详情型的请求路径，则只允许 `GET`、 `PUT`、 `DELETE` 这三种方法。

如果是其他请求方法，则直接返回 `405` 表示请求方法不被支持。

这个可以根据 `url` 路径特征，做一个判断即可。

### 判断请求接口是否存在

如果请求的接口，满足了前面的条件，但是我们的系统并没有这个接口，就要用到 `sanic` 的特性了。我们可以用 `sanic` 的全局处理，来抛出 `404` 错误。

虽然没有更多后端经验，但是我觉得任何一个 `web` 框架都应该支持这样的全局处理。

### 判断是否要求登录

在我们构建的这个文章系统中，很显然，管理后台是需要登录的。而前台 `h5` 是不需要登录的。这个判断可以根据我们的前缀来进行判断。

至于具体的判断逻辑，我们后面再详细阐述。

### 判断是否是特殊接口

这个我们要利用 `sanic` 自行判断，`sanic` 的蓝图设计（你可以把他理解为路由）是可以设置变量的。通过变量，`sanic` 会自动去判断并调用不同的程序进行处理。

### 自动加载前后处理

我们要用特定的规则，去设计可以被自动加载的模块，当请求参数与之相匹配的时候，则自动调用这些模块进行处理。

简单来说，前处理，就是对你请求的参数进行处理。举个例子，如果你没有传某个参数，程序就自动把这个参数给追加上。又或者，程序要检查你的入参是否正确，如果不正确，程序则会返回参数错误，让你检查参数。

而后处理，则是对将要返回的结果进行处理。举个例子，我现在要获取文章列表，但是这个列表中包含了详情，这是一个非常大的字段，比较占用网络资源。而前端作为列表渲染，是完全没有必要使用这个字段的。那么，我们就可以在后处理中把这个字段给删除，从而优化处理结果。

自然也可以用在其它的需求，要看具体的情况。

因为我们想要设计的系统的 `RESTful` 接口是基于数据库自动生成的。这些接口又可能需要特殊的处理，那么这个自动加载前后处理程序的模块，就是重中之重了。

咋实现？回头再想呗。

### ORM 数据库查询以及返回

这个就比较好理解了，根据请求参数，将参数分析整理，构建成 `ORM` 语句，进行对应的数据库操作即可。

如果参数异常，则返回异常。否则，就返回正确的处理结果即可。

### 特殊接口处理

其实这个没什么，就是按照最原始的方法去写接口呗，该咋处理咋处理就是了。

好，我们的后端系统的流程已经分析出来了。我们休息一下！

> 本文由 FungLeo 原创，未经书面许可，严禁转载。

