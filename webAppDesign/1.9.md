# Web应用开发实录后端篇 后端程序编写 构建 session 工具类 （一）

前文中，我们完成了一个假的登录，这个登录太假了，用户名写死啥的不说，最最重要的是，根本就没有实现登录功能！就返回了一个“登录成功”的字符串，这能叫登录成功？

莫着急，咱慢慢来。要实现登录，必须知道登录的原理是什么。

## 搞清楚原理到底是个球

我们来想一下，用户想服务端发送了用户名和密码信息，服务端要检查信息是否合法有效。在检查合法之后，向客户端发送一个加密的秘钥。然后客户端请求其他需要登录的接口的时候，会自动带上这个秘钥，服务端先验证秘钥是否是合法的秘钥，是就办理业务，否则返回要求登录。

这就好比我们去银行办理业务，银行卡就是我们的用户名密码。而我们每次去银行办理业务，需要取一个临时的办理号牌，等到叫号了，我们拿这个临时的号牌去办理业务。

这里面有几个关键点：

1. 服务端如何生成临时秘钥。
2. 服务端生成秘钥之后，存放在哪里。
3. 客户端拿到秘钥后，如何自动带上。
4. 服务端如何检查客户端自带的秘钥。

其中第三个问题是最好解决的，那就是 `cookie`。服务端可以向浏览器设置 `cookie`，然后浏览器下次请求其他数据的时候，就会自动带上了。

> 我这里一直再说秘钥，并不是说它就叫秘钥。准确的叫法是 `token`，也就是令牌。我这么说是为了让新手好理解。

我解释一下这些名词的含义：

`token` 令牌，秘钥。客户端与服务端沟通的钥匙，一般是加密字符串。
`cookie` 饼干。浏览器端存放 `token` 的，每次请求会自动带上 `token`。
`session` 会话控制。服务端生成、删除、检查、更新 `token` 的功能。

> 我的解释并不是字典型的解释，而是为了便于看官的理解，大大降低认知障碍的解释。所以我的解释并不一定是绝对正确的。想要标准考试答案，请参考专业资料的专业解释。没办法，我只会说人话。

**第一，服务端如何生成临时秘钥？**

我们可以根据用户的用户名，外加管理权限，加上时间戳，再整一个随机数，就可以生成一个加密的字符串了。当然，你要更加专业牛逼的算法，也可以再加其他的内容进行计算。

**第二，服务端生成秘钥后，存放在哪里？**

回答是，想存哪里存哪里。只要你能读取到。常见的方式有如下：

1. 存放在文件中。这种存储方法好处是持久化，程序重新运行后，还在。甚至服务器重启之后，都还在。当然，缺点也是非常明显的。那就是有很高的磁盘占用 `IO`，性能很不理想。
2. 存放在内存中。程序随便找个地方构建字典，然后存放在里面就好了。好处，速度嗷嗷快呀。缺点呢就是程序一重启，就丢了。
3. 存放在 `redis` 数据库中。好处，内存型数据库，速度嗷嗷快。并且可以持久化，不怕丢失。缺点，需要安装 `redis` 数据库。

在正式开发的项目中，可以用 `redis` 就用 `redis`。如果不行，就存在内存中，因为服务再运行时，是不会一直重启的。因此只要不挂掉，登录信息也是安全的。

在本文的示例中，我准备将信息存放在文件中。原因是在开发过程中，我得一直重启服务。另外，我实在不想安装 `redis` 数据库。

## 生成秘钥

我们在文件规划中，规划了一个专门处理 `session` 的文件，就是 `/core/session.py`。

我是这样设计我们的秘钥的，首先，用户向我发起登录时，我是知道用户名。此外，登录的是我们的后台管理，因此，我是知道它是属于什么角色的。我们用**用户名**、**时间戳**、**随机数**来构建一个加密字符串，然后根据用户角色以及用户名为名称，搞一个文本文件存在硬盘上。

所谓加密，搞个最简单的算法吧，取哈希值。直接用 `md5` 吧，比较简单。我们去给 `/core/tool.py` 文件添加一个处理 `md5` 的方法。

```python
# 获取 md5 哈希值
def getMd5(source):
    if isinstance(source, str):
        source = source.encode('utf-8')
    m1 = hashlib.md5()
    m1.update(source)
    res = m1.hexdigest()
    return res
```

笨就笨点，就这么干了。

现在我们来编辑 `/core/session.py` 文件：

```python
#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
import time
import random
import os
from core.tool import getMd5

TEMPPATH = 'temp/'

def makeToken (user, group, token=None):
    t = str(int(time.time()))
    if token == None:
        r = str(random.randint(10000, 99999))
        data = user + t + r
        token = getMd5(data)
    tokenPath = TEMPPATH + group + '_' + getMd5(user)
    os.system('echo ' + token + ',' + t + ' > ' + tokenPath)
    return user + '|' + group + '|' + token
```

知识点：

- 获取时间戳方法 `time.time()`
- 生成随机数方法 `random.randint(10000, 99999)`
- 调用系统命令方法 `os.system()`

我这边没有使用 `python` 的写入文件的方法，而是直接调用了 `linux` 系统的命令。一方面是这样写比较短，并且最终，我们的代码一定是在 `linux` 服务器上跑的。二一个，我希望大家能够学习到这个用法。我并不确定这个命令是否能再 `windows` 下运行，如果不能，改成 `python` 写法并不困难。

> 本文由 FungLeo 原创，未经书面许可，严禁转载。

